<div class="p-2">
  <div class="flex my-5 mx-2 justify-between items-center">
    <h2 class="text-2xl text-blue-900">Trips planned</h2>
    <button class="bg-blue-100 text-blue-900 rounded-md border-none h-7 w-20 text-sm cursor-pointer"  onclick="openModal()" >
      Add trip
    </button>
  </div>
</div>
<div>
  <table class="w-full table-fixed">
    <thead class="text-left bg-gray-100 ">
      <tr>
        <th class="py-2 pl-4">Title </th>
        <th> Date </th>
        <th class="w-35"> </th>
      </tr>
    </thead>
    <tbody>
      <% if @trips.present? %>
        <% @trips.each_with_index do |trip, index| %>
          <tr id="trip-<%= trip.id %>" class=<%= index % 2 != 0 && "bg-gray-50 " %>>
            <td class="pl-4"><%= link_to trip.title, trip  %></td>
            <td><%= trip.date.present? ? trip.date.strftime(t('date.formats.default')) : '--' %></td>
            <td class="flex items-center justify-end mr-2">
            <button onclick="editTrip({id: <%= trip.id %>, title: '<%=  trip.title  %>', date: '<%=  trip.date  %>'})" class="rounded-lg py-2 px-1 my-1 inline-block font-medium cursor-pointer">
            <%= image_tag("/images/editPencil.svg") %>
           </button>
            <button onclick="removeTrip(<%= trip.id  %>)" class="rounded-lg py-2 px-1 my-1 inline-block font-medium cursor-pointer">
           <%=  image_tag("/images/trash.svg")  %>
          </button>
             </td>
            </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>

  <div id="modal_create_trip" data-resource-license=""  class="min-w-full mt-3 hidden">
    <%= render :partial => 'modal_create_trip' %>
  </div>
</div>


<script>

  function editTrip(trip) {
    const modal = document.getElementById('modal_create_trip');
    modal.classList.remove('hidden');
    modal.dataset.id = trip.id;
    document.getElementById('modal-content').querySelector('h2').textContent = 'Update Trip';
    document.getElementById('trip_title').value = trip.title;
    document.getElementById('trip_method').value = 'PUT';
    if (trip.date) {
      const dateObject = new Date(trip.date);
      const formattedDate = dateObject.toISOString().slice(0, 10);
      document.getElementById('trip_date').value = formattedDate;
    }
  }

  function openModal() {
    const modal = document.getElementById('modal_create_trip');
    modal.classList.remove('hidden');
    modal.dataset.id = '';
    document.getElementById('modal-content').querySelector('h2').textContent = 'New Trip';
    document.getElementById('trip_title').value = '';
    document.getElementById('trip_date').value = '';
    document.getElementById('trip_method').value = 'POST';
  }

  function removeTrip(tripId) {
    if(tripId) {
      fetch(`/trips/${tripId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
      })
      .then(response => {
        if (response.ok) {
          document.getElementById(`trip-${tripId}`).remove();
          alert('Trip removed!');
        } else {
          alert('Could not remove trip');
        }
      }).catch((error) => {
        console.log(error, 'error')
      })
    } else  {
      alert('not valid');
    }
  }
</script>
